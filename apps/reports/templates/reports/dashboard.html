{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4"><i class="bi bi-bar-chart-line"></i> Raporty i Statystyki</h2>

    <!-- Nowa kolumna w dashboardzie -->
    <div class="col-md-6">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white fw-bold">Skuteczność Nawyków (30 dni)</div>
            <div class="card-body">
                <ul class="list-group list-group-flush" id="habitStatsList">
                    <!-- Tu JS wstawi dane -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Nowa karta: Zdrowie Zadań Cyklicznych -->
    <div class="col-md-6 mt-4">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white fw-bold">Regularność Zadań (Średnie Opóźnienie)</div>
            <div class="card-body">
                <!-- TO JEST TEN ELEMENT -->
                <ul class="list-group list-group-flush" id="recurringStats">
                    <li class="text-center text-muted small py-3">Ładowanie danych...</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Wykres 1: Status Zadań -->
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white fw-bold">Status Zadań (Snapshot)</div>
                <div class="card-body">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Wykres 2: Aktywność (Placeholder na przyszłość) -->
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white fw-bold">Twoja Produktywność</div>
                <div class="card-body text-center py-5">
                    <h3 class="display-4" id="completedCount">--</h3>
                    <p class="text-muted">Zadań ukończonych w ostatnich 7 dniach</p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">Balans Życia (Obszary)</div>
            <div class="card-body">
                <canvas id="areaChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Nowy rząd dla Kontekstów -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white fw-bold">Mapa Kontekstów (Gdzie?)</div>
                <div class="card-body">
                    <canvas id="contextChart"></canvas>
                </div>
            </div>
        </div>
        <!-- Tu w przyszłości Chmura Tagów -->
    </div>

</div>

<!-- Import Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Pobierz dane z API
        fetch("{% url 'stats_api' %}")
            .then(response => response.json())
            .then(data => {

                // --- A. Licznik Produktywności ---
                const countEl = document.getElementById('completedCount');
                if(countEl) countEl.innerText = data.completed;

                // --- B. Wykres Statusów (Status Chart) ---
                const statusCtx = document.getElementById('statusChart');
                if (statusCtx) {
                    const labels = Object.keys(data.breakdown);
                    const values = Object.values(data.breakdown);

                    const colors = {
                        'todo': '#ffc107',
                        'done': '#198754',
                        'waiting': '#0dcaf0',
                        'blocked': '#dc3545',
                        'scheduled': '#0d6efd'
                    };
                    const bgColors = labels.map(label => colors[label] || '#6c757d');

                    new Chart(statusCtx.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: values,
                                backgroundColor: bgColors,
                                borderWidth: 1
                            }]
                        },
                        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
                    });
                }

                // --- C. Wykres Obszarów (Area Chart) ---
                const areaCtx = document.getElementById('areaChart');
                if (areaCtx && data.area_chart) {
                    new Chart(areaCtx.getContext('2d'), {
                        type: 'pie',
                        data: {
                            labels: data.area_chart.labels,
                            datasets: [{
                                data: data.area_chart.data,
                                backgroundColor: data.area_chart.colors
                            }]
                        },
                        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
                    });
                }

                // --- D. Lista Nawyków (Habit Stats) - NOWE ---
                const habitList = document.getElementById('habitStatsList');
                if (habitList && data.habit_stats) {
                    habitList.innerHTML = ''; // Wyczyść placeholder

                    data.habit_stats.forEach(habit => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex justify-content-between align-items-center';

                        // Kolor paska: zielony > 80%, żółty > 50%, czerwony < 50%
                        let colorClass = 'bg-danger';
                        if (habit.rate_30d > 80) colorClass = 'bg-success';
                        else if (habit.rate_30d > 50) colorClass = 'bg-warning';

                        li.innerHTML = `
                            <span>${habit.title}</span>
                            <div class="d-flex align-items-center" style="width: 150px;">
                                <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                    <div class="progress-bar ${colorClass}" role="progressbar"
                                         style="width: ${habit.rate_30d}%"
                                         aria-valuenow="${habit.rate_30d}" aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                                <small class="text-muted fw-bold">${habit.rate_30d}%</small>
                            </div>
                        `;
                        habitList.appendChild(li);
                    });

                    if (data.habit_stats.length === 0) {
                        habitList.innerHTML = '<li class="list-group-item text-muted text-center">Brak aktywnych nawyków.</li>';
                    }
                }


                // Zakładam, że dodasz <ul> id="recurringStats" w HTML
                if (data.recurring_stats) {
                    const list = document.getElementById('recurringStats');
                    list.innerHTML = '';
                    data.recurring_stats.forEach(item => {
                        let badgeClass = item.avg_delay < 1 ? 'bg-success' : (item.avg_delay < 3 ? 'bg-warning' : 'bg-danger');
                        list.innerHTML += `<li class="list-group-item d-flex justify-content-between">
                            ${item.title}
                            <span class="badge ${badgeClass}">Opóźnienie: ${item.avg_delay} dni</span>
                        </li>`;
                    });
                }

                // Context Chart (Bar Chart dla odmiany)
                if (data.context_chart) {
                    const ctxCtx = document.getElementById('contextChart').getContext('2d');
                    new Chart(ctxCtx, {
                        type: 'bar', // Słupkowy, bo nazw może być dużo
                        data: {
                            labels: data.context_chart.labels,
                            datasets: [{
                                label: 'Liczba zadań',
                                data: data.context_chart.data,
                                backgroundColor: data.context_chart.colors
                            }]
                        },
                        options: {
                            indexAxis: 'y', // Poziomy wykres
                            responsive: true
                        }
                    });
                }

                let badgeClass = item.avg_delay < 1 ? 'bg-success' : 'bg-warning';

                list.innerHTML += `
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>${item.title}</strong>
                            <span class="badge ${badgeClass}">Opóźnienie: ${item.avg_delay} dni</span>
                        </div>

                        <!-- Pasek Skuteczności -->
                        <div class="mt-2">
                            <div class="d-flex justify-content-between small text-muted mb-1">
                                <span>Skuteczność</span>
                                <span>${item.rate}% (${item.total} gen.)</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-info" role="progressbar" style="width: ${item.rate}%"></div>
                            </div>
                        </div>
                    </li>`;

            })
            .catch(error => console.error('Błąd pobierania statystyk:', error));
    });
</script>
{% endblock %}